<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Widget / GRBLaser</title>

<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<script type='text/javascript' src="http://www.chilipeppr.com/js/require.js"></script>


<style type='text/css'>
    #com-chilipeppr-widget-grblaser .enabled{
        background-color: #CCFF99;
    }
</style>

<script type='text/javascript'>//<![CDATA[

// Test this element. This code is auto-removed by the chilipeppr.load()
cprequire_test(["inline:com-chilipeppr-widget-grblaser"], function (grbl) {
    grbl.init();

    var sendLaserOnOff = function(isOn) {
        setTimeout(function() {
            grbl.sendCode((isOn) ? grbl.CODE.TOOL_OFF : grbl.CODE.TOOL_ON);
            sendLaserOnOff(!isOn);
        }, 10000);
    };

    sendLaserOnOff();

    chilipeppr.publish("/com-chilipeppr-widget-3dviewer/sceneReloaded",
            {
                min: {
                    x: 100,
                    y: 200,
                    z: 300
                },
                max: {
                    x: 1000,
                    y: 1001,
                    z: 1002
                }
            }
    );

    setTimeout(function() {
        console.log("Bounding box is ready= " + grbl.goScale.ready);
    }, 1000)

} /*end_test*/ );

cpdefine("inline:com-chilipeppr-widget-grblaser", ["chilipeppr_ready", "jquerycookie"], function () {
    return {
        id: "com-chilipeppr-widget-grblaser",
        url: "https://raw.githubusercontent.com/dattanchu/chilipepprGrblLaser/master/widgets/grblaserControl.html",
        fiddleurl: "https://github.com/dattanchu/chilipepprGrblLaser/blob/master/widgets/grblaserControl.html",
        name: "Widget / GRBLaser",
        desc: "This widget adds GRBL laser specific functionalities and options",
        publish: {
            '/com-chilipeppr-widget-grblaser/laserOnOffChange' : "This signal is published when the laser status has changed from on to off or vice versa"
        },
        subscribe: {
        },
        foreignPublish: {
        },
        foreignSubscribe: {
            "/com-chilipeppr-widget-serialport/recvline" : "When we get a dataline from the serial port",
            "/com-chilipeppr-widget-serialport/send" : "Subscribe to serial send and check that the laser is ON/OFF.",
            "/com-chilipeppr-widget-3dviewer/sceneReloaded" : "Subscribe to 3d widget scene reloaded to get new bounding box"
        },
        CODE : {
            TOOL_ON : "M3",
            TOOL_OFF : "M5"
        },
        STATUS_CODE : {
            OK : "ok"
        },
        checkLaserStatusChange: function (rawMsg) {
            // rawMsg might have spaces and new lines
            var msg = rawMsg.replace(/(^\s+|\s+$|\r\n|\n|\r)/gm,"");
            if (msg === this.CODE.TOOL_ON){
                if (!this.laserStatus.on) {
                    console.log("GRBLaser: Laser Switched to ON");
                    chilipeppr.publish("/com-chilipeppr-widget-grblaser/laserOnOffChange", true);
                }
                this.laserStatus.on = true;
            } else if (msg === this.CODE.TOOL_OFF) {
                if (this.laserStatus.on) {
                    console.log("GRBLaser: Laser Switched to OFF");
                    chilipeppr.publish("/com-chilipeppr-widget-grblaser/laserOnOffChange", false);
                }
                this.laserStatus.on = false;
            }
        },
        updateLaserStatusIndication: function (isOn) {
            if (isOn) {
                $('#com-chilipeppr-widget-grblaser').removeClass("panel-default");
                $('#com-chilipeppr-widget-grblaser').addClass("panel-danger");
                $('#grblaser-current-state').find('.com-chilipeppr-grblaser-state-off').hide();
                $('#grblaser-current-state').find('.com-chilipeppr-grblaser-state-on').show();
            } else {
                $('#com-chilipeppr-widget-grblaser').removeClass("panel-danger");
                $('#com-chilipeppr-widget-grblaser').addClass("panel-default");
                $('#grblaser-current-state').find('.com-chilipeppr-grblaser-state-on').hide();
                $('#grblaser-current-state').find('.com-chilipeppr-grblaser-state-off').show();
            }
        },
        setBoundingBox: function(boundingBox) {
            this.goScale.boundingBox = boundingBox;
            this.goScale.ready = true;
            console.log("Bounding box min=" + JSON.stringify(boundingBox.min) + " max=" +
                    JSON.stringify(boundingBox.max));
        },
        /** Not really working as intended since GRBL status != tool status
         */
        queryCurrentGrblStatus: function () {
            var that = this;
            var statusFinder = function (line) {
                // we got the data (may not be from our request but oh well :)
                var statusRegex = /(Idle|Queue|Run|Hold|Home|Alarm|Check).*/;
                var match = statusRegex.exec(line);
                if (match) {
                    var grblStatus = match[1];
                    chilipeppr.unsubscribe("/com-chilipeppr-widget-serialport/recvline", that, statusFinder);
                }
            };
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/recvline", this, statusFinder);
            // <Idle,MPos:0.000,0.000,0.000,WPos:0.000,0.000,0.000>
            this.sendCode("?");
        },
        progress : {
            percentage: 0,
            currentGcodeLine: 0,
            percentagePerGcodeLine: {}
        },
        /**
         * This method updates the
         */
        updateProgressIndicator: function (line) {
            if (line == this.STATUS_CODE.OK) {
                this.progress.currentGcodeLine++;
                $("#laser-progress-bar").style.width = this.progress.percentage + "%";
                $("#laser-progress-bar").innerHTML = this.progress.percentage + "%";
            }
        },
        handleNewFile: function () {
            this.setBoundingBox();
            this.progress.currentGcodeLine = 0;
        },
        handleGcodeLineBuffered: function (rawMsg) {
            this.checkLaserStatusChange(rawMsg);
            this.updateProgressIndicator(rawMsg);
        },
        init: function () {
            this.setupUiFromCookie();
            this.btnSetup();
            this.forkSetup();
            // TODO(dchu): We still need to figure out the current tool status from GRBL
//            this.queryCurrentGrblStatus();
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/send", this, this.handleGcodeLineBuffered);
            chilipeppr.subscribe("/com-chilipeppr-widget-grblaser/laserOnOffChange", this, this.updateLaserStatusIndication);
            chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/sceneReloaded", this, this.handleNewFile);
            chilipeppr.subscribe("/com-chilipeppr-widget-serialport/recvline", this, this.updateProgressIndicator);

            // initial publish to sync up
            chilipeppr.publish("/com-chilipeppr-widget-grblaser/laserOnOffChange", this.laserStatus.on);
        },
        laserStatus: {
            on: false
        },
        options: null,
        setupUiFromCookie: function() {
            // read vals from cookies
            var options = $.cookie('com-chilipeppr-widget-grblaser-options');

            if (options) {
                options = $.parseJSON(options);
                //console.log("GRBL: just evaled options: ", options);
            } else {
                options = {showBody: true};
            }
            this.options = options;
            //console.log("GRBL: options:", options);
        },
        saveOptionsCookie: function() {
            var options = {
                showBody: this.options.showBody
            };
            var optionsStr = JSON.stringify(options);
            //console.log("GRBL: saving options:", options, "json.stringify:", optionsStr);
            // store cookie
            $.cookie('com-chilipeppr-widget-grblaser-options', optionsStr, {
                expires: 365 * 10,
                path: '/'
            });
        },
        showBody: function(evt) {
            $('#com-chilipeppr-widget-grblaser .panel-body .stat-row').removeClass('hidden');
            $('#com-chilipeppr-widget-grblaser .hidebody span').addClass('glyphicon-chevron-up');
            $('#com-chilipeppr-widget-grblaser .hidebody span').removeClass('glyphicon-chevron-down');
            if ((evt !== null)) {
                this.options.showBody = true;
                this.saveOptionsCookie();
            }
        },
        hideBody: function(evt) {
            $('#com-chilipeppr-widget-grblaser .panel-body .stat-row').addClass('hidden');
            $('#com-chilipeppr-widget-grblaser .hidebody span').removeClass('glyphicon-chevron-up');
            $('#com-chilipeppr-widget-grblaser .hidebody span').addClass('glyphicon-chevron-down');
            if ((evt !== null)) {
                this.options.showBody = false;
                this.saveOptionsCookie();
            }
        },
        goScale : {
            ready : false, // won't be set to true until we have a bounding box on a object
            boundingBox: null,
            refBoundingBoxInScene: null, // Keep the ref so we don't add the bounding box multiple times. NOT USED.
            moveCommand : "G0"
        },
        sendGoScaleGcode: function () {
            if (!this.goScale.ready) {
                this.messageUser("Error go scale", "Bounding box is not available for go scale, did you load an object?");
            } else {
                // TODO(dchu): Perhaps some preconditions in case 3dviewerWidget changes how it stores bbox
                // TODO(dchu): Check that we are using absolute coordinate (i.e. G90) or switch to it and switch back to (G91)
                var bbox = this.goScale.boundingBox;
                // TODO(dchu): Perhaps warning the user to retract their tool head? :-p
                this.sendCode(this.goScale.moveCommand + " X" + bbox.min.x + " Y" + bbox.min.y);
                this.sendCode(this.goScale.moveCommand + " X" + bbox.min.x + " Y" + bbox.max.y);
                this.sendCode(this.goScale.moveCommand + " X" + bbox.max.x + " Y" + bbox.max.y);
                this.sendCode(this.goScale.moveCommand + " X" + bbox.max.x + " Y" + bbox.min.y);
                this.sendCode(this.goScale.moveCommand + " X" + bbox.min.x + " Y" + bbox.min.y);
            }

            // NOTE(dchu): This solution is not as good since we are requesting data that is already available
//            if (!this.goScale.ready) {
//                this.messageUser("Processing Bounding Box", "Getting bounding box from scene");
//                chilipeppr.subscribe("/com-chilipeppr-widget-3dviewer/recv3dObject", function(obj) {
//                    console.log("3d obj:", obj);
//                    var boundingBox = new THREE.BoundingBoxHelper(obj, 0xff0000);
//                    boundingBox.update();
//                    this.goScale.refBoundingBoxInScene = boundingBox;
//
//                    // Create visible bounding box
//                    chilipeppr.publish("/com-chilipeppr-widget-3dviewer/sceneadd", boundingBox);
//                    this.messageUser("Done Bounding Box", "Bounding box found. Sending move gcode ...")
//                }.bind(this));
//                chilipeppr.publish("/com-chilipeppr-widget-3dviewer/request3dObject", "");
//            }
        },
        btnSetup: function() {
            // chevron hide body
            var that = this;
            $('#com-chilipeppr-widget-grblaser .hidebody').click(function(evt) {
                //console.log("GRBL: hide/unhide body");
                if ($('#com-chilipeppr-widget-grblaser .panel-body .stat-row').hasClass('hidden')) {
                    // it's hidden, unhide
                    that.showBody(evt);
                } else {
                    // hide
                    that.hideBody(evt);
                }
            });

            $('#com-chilipeppr-widget-grblaser .go-scale').click(function() {
                that.sendGoScaleGcode();
            });

            $('#com-chilipeppr-widget-grblaser .laser-on-button').click(function() {
                that.sendCode(that.CODE.TOOL_ON);
            });
            $('#com-chilipeppr-widget-grblaser .laser-off-button').click(function() {
                that.sendCode(that.CODE.TOOL_OFF);
            });

            $('#com-chilipeppr-widget-grblaser .btn-toolbar .btn').popover({
                delay: 500,
                animation: true,
                placement: "auto",
                trigger: "hover",
                container: 'body'
            });
        },
        /**
         * Just a wrapper for publishing a message that our user can see
         * @see flashmsg in Bootscript for an example
         * @param title
         * @param message
         */
        messageUser: function(title, message) {
            chilipeppr.publish("/com-chilipeppr-elem-flashmsg/flashmsg", title, message);
        },
        sendCode: function (sendline){
            chilipeppr.publish("/com-chilipeppr-widget-serialport/send", sendline + "\n"); //send to serial port
        },
        forkSetup: function () {
            var topCssSelector = '#com-chilipeppr-widget-grblaser';

            //$(topCssSelector + ' .fork').prop('href', this.fiddleurl);
            //$(topCssSelector + ' .standalone').prop('href', this.url);
            //$(topCssSelector + ' .fork-name').html(this.id);
            $(topCssSelector + ' .panel-title').popover({
                title: this.name,
                content: this.desc,
                html: true,
                delay: 200,
                animation: true,
                trigger: 'hover',
                placement: 'auto'
            });

            var that = this;

            chilipeppr.load("http://fiddle.jshell.net/chilipeppr/zMbL9/show/light/", function () {
                require(['inline:com-chilipeppr-elem-pubsubviewer'], function (pubsubviewer) {
                    pubsubviewer.attachTo($('#com-chilipeppr-widget-grblaser .panel-heading .dropdown-menu'), that);
                });
            });

        }
    };
});
//]]>
</script>
</head>
<body>
<div id="com-chilipeppr-widget-grblaser" class="panel panel-default">
    <div class="panel-heading">
        <span class="panel-title" data-toggle="popover">Laser Controls</span>
        <div class="btn-toolbar pull-right" role="toolbar" >
            <div class="btn-group">
                <div class="dropdown">
                    <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-right" role="menu">
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="com-chilipeppr-widget-grblaser-body" class="panel-body">
        <div id="laser-progress-bar" class="row">
            <div class="col-sm-4">
                Gcode Line Progress <span class="progress-text">?/?</span>
            </div>
            <div class="col-sm-8">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                        0%
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-4">
                <div id="grblaser-current-state">Laser is <span class="label label-danger com-chilipeppr-grblaser-state-on">ON</span><span class="label label-success com-chilipeppr-grblaser-state-off">OFF</span></div>
            </div>
            <div class="col-sm-8">
                <div class="btn-group ">
                    <button class="btn btn-xs btn-danger laser-on-button"><span class="glyphicon glyphicon-fire"> </span> Turn Laser ON</button>
                    <button class="btn btn-xs btn-success laser-off-button"><span class="glyphicon glyphicon-remove"> </span> Turn Laser OFF</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-4">
                <div class="btn-group">
                    <button class="btn btn-xs btn-default go-scale">Go Scale</button>
                </div>
            </div>
            <div class="col-sm-4">
                Zero Coordinate System
                <div class="btn-group">
                    <button class="btn btn-xs btn-default zero-coordinate-system-1">1</button>
                    <button class="btn btn-xs btn-default zero-coordinate-system-2">2</button>
                    <button class="btn btn-xs btn-default zero-coordinate-system-3">3</button>
                </div>
            </div>
            <div class="col-sm-4">
            </div>
        </div>

    </div>
    <div id="com-chilipeppr-widget-grblaser-ftr" class="panel-footer" style="font-size:10px;">Work in progress - to report issues please email <a href="mailto:dattanchu@gmail.com">dattanchu@gmail.com</a> (v0.1)</div>
</div>
</body>
</html>

